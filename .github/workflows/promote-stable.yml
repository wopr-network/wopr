name: Promote Stable

on:
  schedule:
    # Run nightly at 03:00 UTC
    - cron: '0 3 * * *'
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write
  issues: write

jobs:
  promote:
    name: Promote ${{ matrix.image }}
    runs-on: [self-hosted, Linux, X64]
    strategy:
      fail-fast: false
      matrix:
        include:
          - image: wopr
          - image: wopr-slim

    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull latest image
        run: docker pull ghcr.io/wopr-network/${{ matrix.image }}:latest

      - name: Smoke test
        id: smoke
        run: |
          CONTAINER_NAME="smoke-${{ matrix.image }}-$$"

          # Start container in background (no host port mapping needed)
          docker run -d --name "$CONTAINER_NAME" \
            ghcr.io/wopr-network/${{ matrix.image }}:latest

          # Poll health from INSIDE the container using wget (busybox default on
          # Alpine -- works on both wopr and wopr-slim images without extra deps).
          # This avoids DinD networking issues: runner and smoke containers are
          # siblings sharing a Docker daemon but in separate network namespaces,
          # so bridge IPs are unreachable from the runner container.
          HEALTHY=false
          echo "Polling health from inside container (docker exec wget) ..."
          for i in $(seq 1 30); do
            # Check container is still running
            if ! docker ps --filter "name=$CONTAINER_NAME" --format '{{.Status}}' | grep -q "Up"; then
              echo "Container exited unexpectedly"
              docker logs "$CONTAINER_NAME" 2>&1 | tail -40
              break
            fi
            if docker exec "$CONTAINER_NAME" \
              wget -q -O /dev/null --timeout=5 "http://localhost:7437/health" 2>/dev/null; then
              HEALTHY=true
              break
            fi
            sleep 2
          done

          # Dump container logs on failure before cleanup
          if [ "$HEALTHY" != "true" ]; then
            echo "--- container logs (last 60 lines) ---"
            docker logs "$CONTAINER_NAME" 2>&1 | tail -60
            echo "--- end container logs ---"
          fi

          # Cleanup
          docker rm -f "$CONTAINER_NAME" > /dev/null 2>&1 || true

          if [ "$HEALTHY" = "true" ]; then
            echo "result=pass" >> "$GITHUB_OUTPUT"
            echo "Health check passed for ${{ matrix.image }}:latest"
          else
            echo "result=fail" >> "$GITHUB_OUTPUT"
            echo "Health check FAILED for ${{ matrix.image }}:latest"
          fi

      - name: Retag as stable and staging
        if: steps.smoke.outputs.result == 'pass'
        run: |
          IMAGE="ghcr.io/wopr-network/${{ matrix.image }}"

          docker tag "${IMAGE}:latest" "${IMAGE}:stable"
          docker tag "${IMAGE}:latest" "${IMAGE}:staging"

          docker push "${IMAGE}:stable"
          docker push "${IMAGE}:staging"

          echo "Promoted ${{ matrix.image }}:latest -> :stable + :staging"

      - name: Alert on failure
        if: steps.smoke.outputs.result == 'fail'
        uses: actions/github-script@v8
        with:
          script: |
            const image = '${{ matrix.image }}';
            const title = `Stable promotion failed: ${image}:latest`;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const body = [
              `The nightly promotion smoke test failed for \`ghcr.io/wopr-network/${image}:latest\`.`,
              '',
              `The \`:stable\` and \`:staging\` tags were **not** updated.`,
              '',
              `**Workflow run:** ${runUrl}`,
              '',
              `Please investigate the health check failure before the next promotion window.`,
            ].join('\n');

            // Search for an existing open issue with the same title and label
            const { data: existing } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'devops',
            });
            const match = existing.find(i => i.title === title);

            if (match) {
              // Add a comment to the existing issue instead of creating a duplicate
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: match.number,
                body: `Still failing.\n\n${body}`,
              });
              core.info(`Commented on existing issue #${match.number}`);
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['devops'],
              });
            }

      - name: Fail workflow on smoke test failure
        if: steps.smoke.outputs.result == 'fail'
        run: exit 1
