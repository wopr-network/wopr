name: Promote Stable

on:
  schedule:
    # Run nightly at 03:00 UTC
    - cron: '0 3 * * *'
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write
  issues: write

jobs:
  promote:
    name: Promote ${{ matrix.image }}
    runs-on: [self-hosted, Linux, X64]
    strategy:
      fail-fast: false
      matrix:
        include:
          - image: wopr
          - image: wopr-slim

    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull latest image
        run: docker pull ghcr.io/wopr-network/${{ matrix.image }}:latest

      - name: Smoke test
        id: smoke
        run: |
          CONTAINER_NAME="smoke-${{ matrix.image }}-$$"

          # Start container in background (loopback only)
          docker run -d --name "$CONTAINER_NAME" \
            -p 127.0.0.1:0:7437 \
            ghcr.io/wopr-network/${{ matrix.image }}:latest

          # Resolve the host port assigned to container port 7437
          # Use awk to grab the last colon-separated field (handles IPv6 format like :::49153)
          HOST_PORT=$(docker port "$CONTAINER_NAME" 7437 | head -1 | awk -F: '{print $NF}')
          if [ -z "$HOST_PORT" ]; then
            echo "ERROR: Could not resolve host port for container $CONTAINER_NAME"
            docker rm -f "$CONTAINER_NAME" > /dev/null 2>&1 || true
            echo "result=fail" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Wait up to 60s for the health endpoint to respond
          HEALTHY=false
          echo "Polling http://localhost:${HOST_PORT}/health ..."
          for i in $(seq 1 30); do
            # Check container is still running
            if ! docker ps --filter "name=$CONTAINER_NAME" --format '{{.Status}}' | grep -q "Up"; then
              echo "Container exited unexpectedly"
              docker logs "$CONTAINER_NAME" 2>&1 | tail -40
              break
            fi
            if curl -sf --max-time 5 --connect-timeout 3 "http://localhost:${HOST_PORT}/health" > /dev/null 2>&1; then
              HEALTHY=true
              break
            fi
            sleep 2
          done

          # Dump container logs on failure before cleanup
          if [ "$HEALTHY" != "true" ]; then
            echo "--- container logs (last 60 lines) ---"
            docker logs "$CONTAINER_NAME" 2>&1 | tail -60
            echo "--- end container logs ---"
          fi

          # Cleanup
          docker rm -f "$CONTAINER_NAME" > /dev/null 2>&1 || true

          if [ "$HEALTHY" = "true" ]; then
            echo "result=pass" >> "$GITHUB_OUTPUT"
            echo "Health check passed for ${{ matrix.image }}:latest"
          else
            echo "result=fail" >> "$GITHUB_OUTPUT"
            echo "Health check FAILED for ${{ matrix.image }}:latest"
          fi

      - name: Retag as stable and staging
        if: steps.smoke.outputs.result == 'pass'
        run: |
          IMAGE="ghcr.io/wopr-network/${{ matrix.image }}"

          docker tag "${IMAGE}:latest" "${IMAGE}:stable"
          docker tag "${IMAGE}:latest" "${IMAGE}:staging"

          docker push "${IMAGE}:stable"
          docker push "${IMAGE}:staging"

          echo "Promoted ${{ matrix.image }}:latest -> :stable + :staging"

      - name: Alert on failure
        if: steps.smoke.outputs.result == 'fail'
        uses: actions/github-script@v7
        with:
          script: |
            const image = '${{ matrix.image }}';
            const title = `Stable promotion failed: ${image}:latest`;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const body = [
              `The nightly promotion smoke test failed for \`ghcr.io/wopr-network/${image}:latest\`.`,
              '',
              `The \`:stable\` and \`:staging\` tags were **not** updated.`,
              '',
              `**Workflow run:** ${runUrl}`,
              '',
              `Please investigate the health check failure before the next promotion window.`,
            ].join('\n');

            // Search for an existing open issue with the same title and label
            const { data: existing } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'devops',
            });
            const match = existing.find(i => i.title === title);

            if (match) {
              // Add a comment to the existing issue instead of creating a duplicate
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: match.number,
                body: `Still failing.\n\n${body}`,
              });
              core.info(`Commented on existing issue #${match.number}`);
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['devops'],
              });
            }

      - name: Fail workflow on smoke test failure
        if: steps.smoke.outputs.result == 'fail'
        run: exit 1
